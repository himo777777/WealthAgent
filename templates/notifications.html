{% extends "wealth_agent/base.html" %}

{% block title %}Notiser - AI Wealth Agent{% endblock %}
{% block page_title %}Notiser{% endblock %}

{% block content %}
<div class="notifications-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h2><i class="fas fa-bell"></i> Notiser</h2>
            <p>Paminnelser, varningar och mojligheter</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="markAllRead()">
                <i class="fas fa-check-double"></i> Markera alla lasta
            </button>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">
            Alla <span class="count" id="allCount">0</span>
        </button>
        <button class="filter-tab" data-filter="reminder">
            <i class="fas fa-clock"></i> Paminnelser
        </button>
        <button class="filter-tab" data-filter="opportunity">
            <i class="fas fa-lightbulb"></i> Mojligheter
        </button>
        <button class="filter-tab" data-filter="alert">
            <i class="fas fa-exclamation-triangle"></i> Varningar
        </button>
        <button class="filter-tab" data-filter="achievement">
            <i class="fas fa-trophy"></i> Prestationer
        </button>
    </div>

    <!-- Notifications List -->
    <div id="notificationsList" class="notifications-list"></div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fas fa-bell-slash"></i>
        <h3>Inga notiser</h3>
        <p>Du har inga olasta notiser just nu</p>
    </div>
</div>

<style>
.notifications-page { max-width: 800px; }

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
}

.header-content h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.header-content h2 i { color: var(--primary); }

.filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
}

.filter-tab {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 0.6rem 1rem;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    transition: all 0.2s;
}

.filter-tab:hover { background: var(--surface-light); }

.filter-tab.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.filter-tab .count {
    background: rgba(255,255,255,0.2);
    padding: 0.1rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
}

.notifications-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.notification-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-item:hover {
    border-color: var(--primary);
}

.notification-item.unread {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent);
    border-left: 3px solid var(--primary);
}

.notification-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.notification-icon.reminder { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
.notification-icon.opportunity { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
.notification-icon.alert { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.notification-icon.achievement { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
.notification-icon.tip { background: rgba(99, 102, 241, 0.2); color: #818cf8; }

.notification-content { flex: 1; }

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.notification-title {
    font-weight: 600;
    font-size: 1rem;
}

.notification-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
}

.notification-message {
    color: var(--text-muted);
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 0.75rem;
}

.notification-action {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--primary);
    font-size: 0.85rem;
    text-decoration: none;
}

.notification-action:hover { text-decoration: underline; }

.notification-dismiss {
    background: none;
    border: none;
    color: var(--text-muted);
    padding: 0.5rem;
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.2s;
}

.notification-dismiss:hover { opacity: 1; }

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--surface);
    border-radius: 16px;
}

.empty-state i {
    font-size: 3rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.empty-state h3 { margin-bottom: 0.5rem; }
.empty-state p { color: var(--text-muted); }

@media (max-width: 768px) {
    .page-header { flex-direction: column; gap: 1rem; }
    .notification-item { flex-wrap: wrap; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let notifications = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();

    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            renderNotifications();
        });
    });
});

async function loadNotifications() {
    try {
        const response = await WealthAgent.apiCall('/wealth/api/notifications?include_read=true');
        if (response.success) {
            notifications = response.notifications;
            document.getElementById('allCount').textContent = response.unread_count;
            renderNotifications();
        }
    } catch (error) {
        console.error('Failed to load notifications:', error);
        // Show some sample notifications
        notifications = getSampleNotifications();
        renderNotifications();
    }
}

function getSampleNotifications() {
    return [
        {
            id: 1,
            title: 'Manadssparande',
            message: 'Dags att satta in 5 000 SEK pa ditt ISK-konto enligt din sparplan.',
            notification_type: 'reminder',
            is_read: false,
            created_at: new Date().toISOString(),
            action_label: 'Ga till Auto-Invest',
            action_url: '/wealth/auto-invest'
        },
        {
            id: 2,
            title: 'Ny mojlighet hittad!',
            message: 'Vi har hittat en sidoinkomstmojlighet som matchar din profil: Medicinskt skrivande.',
            notification_type: 'opportunity',
            is_read: false,
            created_at: new Date(Date.now() - 3600000).toISOString(),
            action_label: 'Utforska',
            action_url: '/wealth/side-income'
        },
        {
            id: 3,
            title: 'Grattis! Ny milstolpe!',
            message: 'Du har natt 25% av ditt sparmal for "Buffert 6 manader"!',
            notification_type: 'achievement',
            is_read: true,
            created_at: new Date(Date.now() - 86400000).toISOString()
        },
        {
            id: 4,
            title: 'Hog kreditkortsranta',
            message: 'Ditt kreditkort har 19.9% ranta. OvervÃ¤g att losa skulden for att spara pengar.',
            notification_type: 'alert',
            is_read: true,
            created_at: new Date(Date.now() - 172800000).toISOString(),
            action_label: 'Se skulder',
            action_url: '/wealth/debt'
        }
    ];
}

function renderNotifications() {
    const list = document.getElementById('notificationsList');
    const empty = document.getElementById('emptyState');

    let filtered = notifications;
    if (currentFilter !== 'all') {
        filtered = notifications.filter(n => n.notification_type === currentFilter);
    }

    if (filtered.length === 0) {
        list.style.display = 'none';
        empty.style.display = 'block';
        return;
    }

    list.style.display = 'flex';
    empty.style.display = 'none';

    list.innerHTML = filtered.map(n => `
        <div class="notification-item ${n.is_read ? '' : 'unread'}" onclick="handleNotificationClick(${n.id})">
            <div class="notification-icon ${n.notification_type}">
                <i class="fas fa-${getNotificationIcon(n.notification_type)}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-header">
                    <span class="notification-title">${n.title}</span>
                    <span class="notification-time">${formatTime(n.created_at)}</span>
                </div>
                <p class="notification-message">${n.message}</p>
                ${n.action_url ? `
                    <a href="${n.action_url}" class="notification-action">
                        ${n.action_label || 'Se mer'} <i class="fas fa-arrow-right"></i>
                    </a>
                ` : ''}
            </div>
            <button class="notification-dismiss" onclick="dismissNotification(event, ${n.id})" title="Avfarda">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function getNotificationIcon(type) {
    const icons = {
        'reminder': 'clock',
        'opportunity': 'lightbulb',
        'alert': 'exclamation-triangle',
        'achievement': 'trophy',
        'tip': 'info-circle'
    };
    return icons[type] || 'bell';
}

function formatTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;

    if (diff < 3600000) {
        return Math.floor(diff / 60000) + ' min sedan';
    } else if (diff < 86400000) {
        return Math.floor(diff / 3600000) + ' tim sedan';
    } else if (diff < 604800000) {
        return Math.floor(diff / 86400000) + ' dagar sedan';
    } else {
        return date.toLocaleDateString('sv-SE');
    }
}

async function handleNotificationClick(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification && !notification.is_read) {
        try {
            await WealthAgent.apiCall(`/wealth/api/notifications/${id}/read`, 'PUT');
            notification.is_read = true;
            renderNotifications();
        } catch (error) {
            // Mark as read locally anyway
            notification.is_read = true;
            renderNotifications();
        }
    }
}

async function dismissNotification(event, id) {
    event.stopPropagation();
    notifications = notifications.filter(n => n.id !== id);
    renderNotifications();
    WealthAgent.showToast('Notis avfardad', 'success');
}

async function markAllRead() {
    notifications.forEach(n => n.is_read = true);
    renderNotifications();
    WealthAgent.showToast('Alla notiser markerade som lasta', 'success');
}
</script>
{% endblock %}
