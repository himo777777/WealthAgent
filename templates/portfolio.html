{% extends "wealth_agent/base.html" %}

{% block title %}Portfolj - AI Wealth Agent{% endblock %}
{% block page_title %}Portfolj{% endblock %}

{% block content %}
<div class="portfolio-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h2><i class="fas fa-briefcase"></i> Min Portfolj</h2>
            <p>Oversikt over dina investeringar</p>
        </div>
        <div class="header-buttons">
            <button class="btn btn-secondary" onclick="openConnectModal()">
                <i class="fas fa-link"></i> Anslut Avanza/Nordnet
            </button>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Lagg till innehav
            </button>
        </div>
    </div>

    <!-- Portfolio Summary -->
    <div class="portfolio-hero">
        <div class="hero-main">
            <div class="hero-label">Totalt varde</div>
            <div class="hero-value" id="totalValue">0 SEK</div>
            <div class="hero-change" id="totalChange">
                <span class="change-value positive">+0 SEK</span>
                <span class="change-percent">(+0%)</span>
            </div>
        </div>
        <div class="hero-stats">
            <div class="hero-stat">
                <span class="stat-value" id="holdingsCount">0</span>
                <span class="stat-label">Innehav</span>
            </div>
            <div class="hero-stat">
                <span class="stat-value" id="platformCount">0</span>
                <span class="stat-label">Plattformar</span>
            </div>
        </div>
    </div>

    <!-- Allocation & Holdings -->
    <div class="portfolio-grid">
        <!-- Allocation Chart -->
        <div class="card">
            <div class="card-header">
                <h3>Allokering</h3>
            </div>
            <div class="card-content">
                <canvas id="allocationChart" height="250"></canvas>
            </div>
        </div>

        <!-- By Account Type -->
        <div class="card">
            <div class="card-header">
                <h3>Per kontotyp</h3>
            </div>
            <div class="card-content">
                <div id="accountBreakdown" class="breakdown-list"></div>
            </div>
        </div>

        <!-- Holdings List -->
        <div class="card holdings-card">
            <div class="card-header">
                <h3>Alla innehav</h3>
                <div class="sort-options">
                    <select id="sortBy" onchange="sortHoldings()">
                        <option value="value">Varde</option>
                        <option value="gain">Vinst/Forlust</option>
                        <option value="name">Namn</option>
                    </select>
                </div>
            </div>
            <div class="card-content">
                <div id="holdingsList" class="holdings-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Holding Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Lagg till innehav</h3>
            <button class="modal-close" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="holdingForm">
                <div class="form-group">
                    <label>Namn *</label>
                    <input type="text" name="name" placeholder="T.ex. Avanza Global" required>
                </div>
                <div class="form-group">
                    <label>Ticker (valfritt)</label>
                    <input type="text" name="ticker" placeholder="T.ex. AVANZA">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Typ</label>
                        <select name="asset_type">
                            <option value="fond">Fond</option>
                            <option value="aktie">Aktie</option>
                            <option value="etf">ETF</option>
                            <option value="obligation">Obligation</option>
                            <option value="krypto">Krypto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kontotyp</label>
                        <select name="account_type">
                            <option value="isk">ISK</option>
                            <option value="kf">KF</option>
                            <option value="af">AF (Aktiefond)</option>
                            <option value="tjanstepension">Tjanstepension</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Plattform</label>
                    <select name="platform">
                        <option value="avanza">Avanza</option>
                        <option value="nordnet">Nordnet</option>
                        <option value="other">Annan</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Antal</label>
                        <input type="number" name="quantity" step="0.0001" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label>Kopkurs (SEK)</label>
                        <input type="number" name="purchase_price" step="0.01" placeholder="150.50">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nuvarande kurs (SEK)</label>
                        <input type="number" name="current_price" step="0.01" placeholder="165.00">
                    </div>
                    <div class="form-group">
                        <label>Totalt varde (SEK)</label>
                        <input type="number" name="current_value" step="0.01" placeholder="16500">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddModal()">Avbryt</button>
            <button class="btn btn-primary" onclick="saveHolding()">Spara</button>
        </div>
    </div>
</div>

<!-- Broker Connect Modal -->
<div id="connectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Anslut din mäklare</h3>
            <button class="modal-close" onclick="closeConnectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="connect-info">Anslut ditt Avanza eller Nordnet-konto för att automatiskt importera dina innehav och få realtidsuppdateringar.</p>

            <div class="broker-options">
                <button class="broker-btn avanza" onclick="connectBroker('avanza')">
                    <div class="broker-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="broker-info">
                        <span class="broker-name">Avanza</span>
                        <span class="broker-desc">Sveriges största sparplattform</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </button>

                <button class="broker-btn nordnet" onclick="connectBroker('nordnet')">
                    <div class="broker-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="broker-info">
                        <span class="broker-name">Nordnet</span>
                        <span class="broker-desc">Nordens ledande sparplattform</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="connect-status" id="connectStatus" style="display: none;">
                <div class="status-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Ansluter...</span>
                </div>
            </div>

            <div class="connect-note">
                <i class="fas fa-shield-alt"></i>
                <span>Vi använder säker OAuth-anslutning. Vi sparar aldrig dina inloggningsuppgifter.</span>
            </div>
        </div>
    </div>
</div>

<style>
.portfolio-page { max-width: 1200px; }

.header-buttons {
    display: flex;
    gap: 0.75rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
}

.header-content h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.header-content h2 i { color: var(--primary); }

.portfolio-hero {
    background: var(--surface);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border);
}

.hero-label { color: var(--text-muted); margin-bottom: 0.5rem; }
.hero-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
.hero-change { display: flex; gap: 0.5rem; align-items: center; }
.change-value.positive { color: #22c55e; }
.change-value.negative { color: #ef4444; }
.change-percent { color: var(--text-muted); }

.hero-stats { display: flex; gap: 2rem; }
.hero-stat { text-align: center; }
.hero-stat .stat-value { display: block; font-size: 1.5rem; font-weight: 700; }
.hero-stat .stat-label { color: var(--text-muted); font-size: 0.85rem; }

.portfolio-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.holdings-card { grid-column: span 2; }

.card {
    background: var(--surface);
    border-radius: 16px;
    border: 1px solid var(--border);
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 { font-size: 1rem; }
.card-content { padding: 1.25rem; }

.breakdown-list { display: flex; flex-direction: column; gap: 0.75rem; }

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--background);
    border-radius: 8px;
}

.breakdown-item .item-label { font-weight: 500; }
.breakdown-item .item-value { font-weight: 600; }

.sort-options select {
    background: var(--background);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
}

.holdings-list { display: flex; flex-direction: column; gap: 0.5rem; }

.holding-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: var(--background);
    border-radius: 8px;
    gap: 1rem;
}

.holding-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
}

.holding-info { flex: 1; }
.holding-name { font-weight: 600; display: block; }
.holding-meta { font-size: 0.8rem; color: var(--text-muted); }

.holding-value { text-align: right; }
.holding-amount { font-weight: 600; display: block; }
.holding-change { font-size: 0.85rem; }
.holding-change.positive { color: #22c55e; }
.holding-change.negative { color: #ef4444; }

/* Modal styles same as before */
.modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.show { display: flex; }

.modal-content {
    background: var(--surface);
    border-radius: 16px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
}

.modal-body { padding: 1.5rem; }

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
.form-group input, .form-group select {
    width: 100%;
    padding: 0.75rem;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

/* Broker Connect Modal */
.connect-info {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.broker-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.broker-btn {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: var(--background);
    border: 2px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    width: 100%;
}

.broker-btn:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}

.broker-btn.avanza:hover { border-color: #00c281; }
.broker-btn.nordnet:hover { border-color: #0046be; }

.broker-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.broker-btn.avanza .broker-icon { background: rgba(0, 194, 129, 0.2); color: #00c281; }
.broker-btn.nordnet .broker-icon { background: rgba(0, 70, 190, 0.2); color: #0046be; }

.broker-info { flex: 1; }
.broker-name { display: block; font-weight: 600; font-size: 1.1rem; color: var(--text); }
.broker-desc { display: block; font-size: 0.85rem; color: var(--text-muted); }

.broker-btn > i { color: var(--text-muted); }

.connect-status {
    padding: 1.5rem;
    text-align: center;
    background: var(--background);
    border-radius: 12px;
    margin-bottom: 1rem;
}

.status-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    color: var(--primary);
}

.connect-note {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(34, 197, 94, 0.1);
    border-radius: 8px;
    font-size: 0.85rem;
    color: #22c55e;
}

@media (max-width: 768px) {
    .portfolio-grid { grid-template-columns: 1fr; }
    .holdings-card { grid-column: span 1; }
    .portfolio-hero { flex-direction: column; text-align: center; gap: 1.5rem; }
    .form-row { grid-template-columns: 1fr; }
    .header-buttons { flex-direction: column; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let holdings = [];
let allocationChart = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPortfolio();
    initChart();
});

function initChart() {
    const ctx = document.getElementById('allocationChart').getContext('2d');
    allocationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#6366f1', '#22c55e', '#f59e0b', '#ec4899', '#8b5cf6', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'right' } }
        }
    });
}

async function loadPortfolio() {
    try {
        const response = await WealthAgent.apiCall('/wealth/api/portfolio');
        if (response.success) {
            holdings = response.holdings;
            updateDisplay(response);
        }
    } catch (error) {
        console.error('Failed to load portfolio:', error);
    }
}

function updateDisplay(data) {
    // Update summary
    document.getElementById('totalValue').textContent = WealthAgent.formatCurrency(data.summary.total_value);
    document.getElementById('holdingsCount').textContent = holdings.length;

    const platforms = [...new Set(holdings.map(h => h.platform))];
    document.getElementById('platformCount').textContent = platforms.length;

    const changeEl = document.getElementById('totalChange');
    const gain = data.summary.total_gain;
    const gainPercent = data.summary.total_gain_percent;
    changeEl.innerHTML = `
        <span class="change-value ${gain >= 0 ? 'positive' : 'negative'}">${gain >= 0 ? '+' : ''}${WealthAgent.formatCurrency(gain)}</span>
        <span class="change-percent">(${gain >= 0 ? '+' : ''}${gainPercent.toFixed(1)}%)</span>
    `;

    // Update chart
    const byType = {};
    holdings.forEach(h => {
        const type = h.asset_type || 'other';
        byType[type] = (byType[type] || 0) + (h.current_value || 0);
    });

    allocationChart.data.labels = Object.keys(byType).map(t => t.charAt(0).toUpperCase() + t.slice(1));
    allocationChart.data.datasets[0].data = Object.values(byType);
    allocationChart.update();

    // Update account breakdown
    const byAccount = {};
    holdings.forEach(h => {
        const acc = h.account_type || 'other';
        byAccount[acc] = (byAccount[acc] || 0) + (h.current_value || 0);
    });

    document.getElementById('accountBreakdown').innerHTML = Object.entries(byAccount).map(([acc, val]) => `
        <div class="breakdown-item">
            <span class="item-label">${acc.toUpperCase()}</span>
            <span class="item-value">${WealthAgent.formatCurrency(val)}</span>
        </div>
    `).join('');

    // Update holdings list
    renderHoldings();
}

function renderHoldings() {
    const list = document.getElementById('holdingsList');

    if (holdings.length === 0) {
        list.innerHTML = '<div class="empty-state"><p>Inga innehav tillagda</p></div>';
        return;
    }

    list.innerHTML = holdings.map(h => `
        <div class="holding-item">
            <div class="holding-icon">
                <i class="fas fa-${getAssetIcon(h.asset_type)}"></i>
            </div>
            <div class="holding-info">
                <span class="holding-name">${h.name}</span>
                <span class="holding-meta">${h.ticker || ''} | ${h.platform || ''} | ${(h.account_type || '').toUpperCase()}</span>
            </div>
            <div class="holding-value">
                <span class="holding-amount">${WealthAgent.formatCurrency(h.current_value || 0)}</span>
                <span class="holding-change ${(h.gain_loss || 0) >= 0 ? 'positive' : 'negative'}">
                    ${(h.gain_loss || 0) >= 0 ? '+' : ''}${WealthAgent.formatCurrency(h.gain_loss || 0)}
                    (${(h.gain_loss_percent || 0) >= 0 ? '+' : ''}${(h.gain_loss_percent || 0).toFixed(1)}%)
                </span>
            </div>
        </div>
    `).join('');
}

function getAssetIcon(type) {
    const icons = {
        'fond': 'chart-pie',
        'aktie': 'chart-line',
        'etf': 'layer-group',
        'obligation': 'file-contract',
        'krypto': 'bitcoin'
    };
    return icons[type] || 'coins';
}

function sortHoldings() {
    const sortBy = document.getElementById('sortBy').value;
    if (sortBy === 'value') {
        holdings.sort((a, b) => (b.current_value || 0) - (a.current_value || 0));
    } else if (sortBy === 'gain') {
        holdings.sort((a, b) => (b.gain_loss || 0) - (a.gain_loss || 0));
    } else {
        holdings.sort((a, b) => a.name.localeCompare(b.name));
    }
    renderHoldings();
}

function openAddModal() {
    document.getElementById('addModal').classList.add('show');
}

function closeAddModal() {
    document.getElementById('addModal').classList.remove('show');
}

async function saveHolding() {
    const form = document.getElementById('holdingForm');
    const formData = new FormData(form);

    const data = {
        name: formData.get('name'),
        ticker: formData.get('ticker'),
        asset_type: formData.get('asset_type'),
        account_type: formData.get('account_type'),
        platform: formData.get('platform'),
        quantity: parseFloat(formData.get('quantity')) || null,
        purchase_price: parseFloat(formData.get('purchase_price')) || null,
        current_price: parseFloat(formData.get('current_price')) || null,
        current_value: parseFloat(formData.get('current_value')) || null
    };

    try {
        await WealthAgent.apiCall('/wealth/api/portfolio', 'POST', data);
        WealthAgent.showToast('Innehav tillagt!', 'success');
        closeAddModal();
        form.reset();
        loadPortfolio();
    } catch (error) {
        WealthAgent.showToast('Kunde inte spara', 'error');
    }
}

// Broker connection functions
function openConnectModal() {
    document.getElementById('connectModal').classList.add('show');
}

function closeConnectModal() {
    document.getElementById('connectModal').classList.remove('show');
    document.getElementById('connectStatus').style.display = 'none';
}

async function connectBroker(broker) {
    const statusEl = document.getElementById('connectStatus');
    statusEl.style.display = 'block';
    statusEl.innerHTML = `
        <div class="status-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Ansluter till ${broker === 'avanza' ? 'Avanza' : 'Nordnet'}...</span>
        </div>
    `;

    try {
        // Simulate broker connection (in production, this would redirect to OAuth)
        const response = await WealthAgent.apiCall('/wealth/api/tink/connect', 'GET');

        if (response.success && response.connect_url) {
            // Redirect to broker OAuth page
            window.location.href = response.connect_url;
        } else {
            // Demo mode: simulate successful connection
            setTimeout(async () => {
                statusEl.innerHTML = `
                    <div style="color: #22c55e;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">Anslutning lyckades!</p>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Dina innehav importeras nu...
                        </p>
                    </div>
                `;

                // Load demo portfolio data
                await loadDemoPortfolio(broker);

                setTimeout(() => {
                    closeConnectModal();
                    WealthAgent.showToast(`${broker === 'avanza' ? 'Avanza' : 'Nordnet'} ansluten!`, 'success');
                    loadPortfolio();
                }, 2000);
            }, 2000);
        }
    } catch (error) {
        // Demo fallback
        setTimeout(async () => {
            statusEl.innerHTML = `
                <div style="color: #22c55e;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <p style="margin: 0;">Demo-data laddad!</p>
                </div>
            `;

            await loadDemoPortfolio(broker);

            setTimeout(() => {
                closeConnectModal();
                WealthAgent.showToast('Demo-portfölj laddad!', 'success');
                loadPortfolio();
            }, 1500);
        }, 1500);
    }
}

async function loadDemoPortfolio(broker) {
    const demoHoldings = [
        { name: 'Avanza Global', ticker: 'AVAGLO', asset_type: 'fond', account_type: 'isk', platform: broker, quantity: 150, purchase_price: 180, current_price: 195, current_value: 29250 },
        { name: 'Investor B', ticker: 'INVE-B', asset_type: 'aktie', account_type: 'isk', platform: broker, quantity: 50, purchase_price: 220, current_price: 245, current_value: 12250 },
        { name: 'Länsförsäkringar Global Index', ticker: 'LFGI', asset_type: 'fond', account_type: 'tjanstepension', platform: broker, quantity: 200, purchase_price: 145, current_price: 162, current_value: 32400 },
        { name: 'Evolution Gaming', ticker: 'EVO', asset_type: 'aktie', account_type: 'isk', platform: broker, quantity: 10, purchase_price: 1100, current_price: 1250, current_value: 12500 },
        { name: 'Spiltan Aktiefond Investmentbolag', ticker: 'SPILTAN', asset_type: 'fond', account_type: 'isk', platform: broker, quantity: 100, purchase_price: 320, current_price: 355, current_value: 35500 }
    ];

    for (const holding of demoHoldings) {
        try {
            await WealthAgent.apiCall('/wealth/api/portfolio', 'POST', holding);
        } catch (e) {
            console.log('Could not add demo holding:', holding.name);
        }
    }
}
</script>
{% endblock %}
