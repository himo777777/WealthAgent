{% extends "wealth_agent/base.html" %}

{% block title %}Gig Economy Tracker - Wealth Agent{% endblock %}

{% block page_title %}Gig Economy Tracker{% endblock %}

{% block content %}
<div class="gig-tracker">
    <!-- Overview Stats -->
    <div class="stats-row">
        <div class="stat-card earnings">
            <div class="stat-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-content">
                <span class="stat-label">Denna manad</span>
                <span class="stat-value" id="monthlyEarnings">0 kr</span>
                <span class="stat-sub" id="monthlyChange">vs forra manaden</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <span class="stat-label">Timmar denna manad</span>
                <span class="stat-value" id="monthlyHours">0 h</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
                <span class="stat-label">Effektiv timpeng</span>
                <span class="stat-value" id="effectiveRate">0 kr/h</span>
                <span class="stat-sub">efter kostnader</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="stat-content">
                <span class="stat-label">Gigs denna manad</span>
                <span class="stat-value" id="monthlyGigs">0</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="btn-action primary" onclick="openLogGigModal()">
            <i class="fas fa-plus"></i> Logga gig
        </button>
        <button class="btn-action" onclick="openExpenseModal()">
            <i class="fas fa-gas-pump"></i> Lagg till kostnad
        </button>
        <button class="btn-action" onclick="toggleView('calendar')">
            <i class="fas fa-calendar-alt"></i> Kalendervy
        </button>
    </div>

    <div class="tracker-grid">
        <!-- Active Platforms -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-th-large"></i> Dina plattformar</h3>
                <button class="btn-small" onclick="openPlatformModal()">
                    <i class="fas fa-plus"></i> Lagg till
                </button>
            </div>
            <div class="card-body">
                <div class="platforms-list" id="platformsList">
                    <div class="platform-item" data-platform="uber">
                        <div class="platform-icon uber">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="platform-info">
                            <span class="platform-name">Uber</span>
                            <span class="platform-earnings">0 kr denna manad</span>
                        </div>
                        <span class="platform-rate">0 kr/h</span>
                    </div>
                    <div class="platform-item" data-platform="foodora">
                        <div class="platform-icon foodora">
                            <i class="fas fa-motorcycle"></i>
                        </div>
                        <div class="platform-info">
                            <span class="platform-name">Foodora</span>
                            <span class="platform-earnings">0 kr denna manad</span>
                        </div>
                        <span class="platform-rate">0 kr/h</span>
                    </div>
                    <div class="platform-item" data-platform="bolt">
                        <div class="platform-icon bolt">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="platform-info">
                            <span class="platform-name">Bolt</span>
                            <span class="platform-earnings">0 kr denna manad</span>
                        </div>
                        <span class="platform-rate">0 kr/h</span>
                    </div>
                </div>
                <div class="empty-state small" id="noPlatforms" style="display: none;">
                    <p>Inga plattformar tillagda</p>
                </div>
            </div>
        </div>

        <!-- Earnings Chart -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-chart-line"></i> Inkomster over tid</h3>
                <div class="chart-toggle">
                    <button class="active" data-period="week">Vecka</button>
                    <button data-period="month">Manad</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="earningsChart" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Gigs -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-history"></i> Senaste gigs</h3>
                <a href="#" class="link-all">Visa alla</a>
            </div>
            <div class="card-body">
                <div class="gigs-list" id="recentGigs">
                    <div class="empty-state small">
                        <p>Inga gigs loggade an</p>
                        <button class="btn-small" onclick="openLogGigModal()">Logga ditt forsta</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Best Times -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-clock"></i> Basta tider att jobba</h3>
            </div>
            <div class="card-body">
                <div class="heatmap" id="timeHeatmap">
                    <div class="heatmap-row">
                        <span class="heatmap-label"></span>
                        <span class="heatmap-day">Man</span>
                        <span class="heatmap-day">Tis</span>
                        <span class="heatmap-day">Ons</span>
                        <span class="heatmap-day">Tor</span>
                        <span class="heatmap-day">Fre</span>
                        <span class="heatmap-day">Lor</span>
                        <span class="heatmap-day">Son</span>
                    </div>
                    <div class="heatmap-row">
                        <span class="heatmap-label">Morgon</span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                    </div>
                    <div class="heatmap-row">
                        <span class="heatmap-label">Lunch</span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                    </div>
                    <div class="heatmap-row">
                        <span class="heatmap-label">Eftermiddag</span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                    </div>
                    <div class="heatmap-row">
                        <span class="heatmap-label">Kvall</span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                    </div>
                    <div class="heatmap-row">
                        <span class="heatmap-label">Natt</span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                        <span class="heatmap-cell" data-value="0"></span>
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span>Lagre timpeng</span>
                    <div class="legend-scale">
                        <span class="legend-cell low"></span>
                        <span class="legend-cell medium"></span>
                        <span class="legend-cell high"></span>
                    </div>
                    <span>Hogre timpeng</span>
                </div>
                <p class="heatmap-tip">Logga fler gigs for att se dina basta tider</p>
            </div>
        </div>

        <!-- Monthly Costs -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-gas-pump"></i> Kostnader denna manad</h3>
            </div>
            <div class="card-body">
                <div class="costs-summary">
                    <div class="cost-item">
                        <span class="cost-icon"><i class="fas fa-gas-pump"></i></span>
                        <span class="cost-label">Bensin/El</span>
                        <span class="cost-value" id="fuelCost">0 kr</span>
                    </div>
                    <div class="cost-item">
                        <span class="cost-icon"><i class="fas fa-car"></i></span>
                        <span class="cost-label">Fordon</span>
                        <span class="cost-value" id="vehicleCost">0 kr</span>
                    </div>
                    <div class="cost-item">
                        <span class="cost-icon"><i class="fas fa-mobile-alt"></i></span>
                        <span class="cost-label">Telefon/Data</span>
                        <span class="cost-value" id="phoneCost">0 kr</span>
                    </div>
                    <div class="cost-item">
                        <span class="cost-icon"><i class="fas fa-receipt"></i></span>
                        <span class="cost-label">Ovrigt</span>
                        <span class="cost-value" id="otherCost">0 kr</span>
                    </div>
                    <div class="cost-item total">
                        <span class="cost-label">Totala kostnader</span>
                        <span class="cost-value" id="totalCosts">0 kr</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goal Progress -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-bullseye"></i> Manadsmol</h3>
                <button class="btn-small" onclick="openGoalModal()">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="goal-progress">
                    <div class="goal-circle" id="goalCircle">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" stroke-width="8"/>
                            <circle cx="50" cy="50" r="45" fill="none" stroke="var(--primary)" stroke-width="8"
                                    stroke-dasharray="283" stroke-dashoffset="283" id="goalProgress"/>
                        </svg>
                        <div class="goal-text">
                            <span class="goal-percent" id="goalPercent">0%</span>
                            <span class="goal-label">av mal</span>
                        </div>
                    </div>
                    <div class="goal-details">
                        <div class="goal-stat">
                            <span class="goal-stat-label">Mal</span>
                            <span class="goal-stat-value" id="goalTarget">10 000 kr</span>
                        </div>
                        <div class="goal-stat">
                            <span class="goal-stat-label">Uppnatt</span>
                            <span class="goal-stat-value" id="goalCurrent">0 kr</span>
                        </div>
                        <div class="goal-stat">
                            <span class="goal-stat-label">Kvar</span>
                            <span class="goal-stat-value" id="goalRemaining">10 000 kr</span>
                        </div>
                    </div>
                </div>
                <div class="goal-projection" id="goalProjection">
                    <i class="fas fa-info-circle"></i>
                    Med nuvarande takt nar du malet <strong>15 dagar</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Gig Modal -->
<div class="modal" id="logGigModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Logga gig</h3>
            <button class="modal-close" onclick="closeModal('logGigModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="gigForm">
                <div class="form-group">
                    <label>Plattform *</label>
                    <select id="gigPlatform" required>
                        <option value="uber">Uber</option>
                        <option value="bolt">Bolt</option>
                        <option value="foodora">Foodora</option>
                        <option value="wolt">Wolt</option>
                        <option value="taskrabbit">TaskRabbit</option>
                        <option value="other">Annat</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Datum *</label>
                        <input type="date" id="gigDate" required>
                    </div>
                    <div class="form-group">
                        <label>Tid pa dagen</label>
                        <select id="gigTimeOfDay">
                            <option value="morning">Morgon (06-10)</option>
                            <option value="lunch">Lunch (10-14)</option>
                            <option value="afternoon">Eftermiddag (14-18)</option>
                            <option value="evening">Kvall (18-22)</option>
                            <option value="night">Natt (22-06)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Inkomst (kr) *</label>
                        <input type="number" id="gigEarnings" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>Arbetstid (minuter) *</label>
                        <input type="number" id="gigMinutes" placeholder="60" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Antal leveranser/korningar</label>
                    <input type="number" id="gigDeliveries" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Tips (kr)</label>
                    <input type="number" id="gigTips" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Anteckningar</label>
                    <textarea id="gigNotes" placeholder="Eventuella anteckningar..."></textarea>
                </div>

                <div class="quick-calc" id="quickCalc">
                    <span>Timpeng: <strong id="calcHourly">0 kr/h</strong></span>
                    <span>Per leverans: <strong id="calcPerDelivery">-</strong></span>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('logGigModal')">Avbryt</button>
            <button class="btn-primary" onclick="saveGig()">
                <i class="fas fa-save"></i> Spara
            </button>
        </div>
    </div>
</div>

<!-- Expense Modal -->
<div class="modal" id="expenseModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-receipt"></i> Lagg till kostnad</h3>
            <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="expenseForm">
                <div class="form-group">
                    <label>Kategori *</label>
                    <select id="expenseCategory" required>
                        <option value="fuel">Bensin/El-laddning</option>
                        <option value="vehicle">Fordon (service, reparation)</option>
                        <option value="phone">Telefon/Data</option>
                        <option value="equipment">Utrustning (vaska, tillbehor)</option>
                        <option value="insurance">Forsakring</option>
                        <option value="other">Ovrigt</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Belopp (kr) *</label>
                        <input type="number" id="expenseAmount" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>Datum *</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Beskrivning</label>
                    <input type="text" id="expenseDescription" placeholder="t.ex. Tankning Shell">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('expenseModal')">Avbryt</button>
            <button class="btn-primary" onclick="saveExpense()">
                <i class="fas fa-save"></i> Spara
            </button>
        </div>
    </div>
</div>

<!-- Goal Modal -->
<div class="modal" id="goalModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-bullseye"></i> Satt manadsmol</h3>
            <button class="modal-close" onclick="closeModal('goalModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="goalForm">
                <div class="form-group">
                    <label>Inkomstmal denna manad (kr)</label>
                    <input type="number" id="goalAmount" placeholder="10000">
                </div>
                <div class="goal-suggestions">
                    <span>Snabbval:</span>
                    <button type="button" onclick="setGoal(5000)">5 000 kr</button>
                    <button type="button" onclick="setGoal(10000)">10 000 kr</button>
                    <button type="button" onclick="setGoal(15000)">15 000 kr</button>
                    <button type="button" onclick="setGoal(20000)">20 000 kr</button>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('goalModal')">Avbryt</button>
            <button class="btn-primary" onclick="saveGoal()">
                <i class="fas fa-save"></i> Spara
            </button>
        </div>
    </div>
</div>

<style>
.gig-tracker {
    padding: 1rem;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--surface);
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border: 1px solid var(--border);
}

.stat-card.earnings {
    background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%);
    color: white;
    border: none;
}

.stat-card.earnings .stat-icon {
    background: rgba(255,255,255,0.2);
    color: white;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.stat-content {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 0.85rem;
    opacity: 0.8;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
}

.stat-sub {
    font-size: 0.75rem;
    opacity: 0.7;
}

.quick-actions {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.btn-action {
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.btn-action:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.btn-action.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.tracker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1rem;
}

.card {
    background: var(--surface);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.card-header h3 i {
    color: var(--primary);
}

.card-body {
    padding: 1.25rem;
}

.btn-small {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
}

.btn-small:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.link-all {
    font-size: 0.85rem;
    color: var(--primary);
    text-decoration: none;
}

.chart-toggle {
    display: flex;
    gap: 0.5rem;
}

.chart-toggle button {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.8rem;
}

.chart-toggle button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* Platforms List */
.platforms-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.platform-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--background);
    border-radius: 8px;
}

.platform-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.platform-icon.uber { background: #000; }
.platform-icon.bolt { background: #34D186; }
.platform-icon.foodora { background: #D70F64; }
.platform-icon.wolt { background: #009DE0; }

.platform-info {
    flex: 1;
}

.platform-name {
    font-weight: 600;
    display: block;
}

.platform-earnings {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.platform-rate {
    font-weight: 600;
    color: var(--success);
}

/* Gigs List */
.gigs-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.gig-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--background);
    border-radius: 8px;
}

.gig-item .gig-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gig-item .gig-info {
    flex: 1;
}

.gig-item .gig-platform {
    font-weight: 600;
}

.gig-item .gig-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.gig-item .gig-earnings {
    text-align: right;
}

.gig-item .gig-amount {
    font-weight: 600;
    color: var(--success);
}

.gig-item .gig-rate {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Heatmap */
.heatmap {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.heatmap-row {
    display: flex;
    gap: 0.35rem;
    align-items: center;
}

.heatmap-label {
    width: 80px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.heatmap-day {
    flex: 1;
    text-align: center;
    font-size: 0.7rem;
    color: var(--text-muted);
}

.heatmap-cell {
    flex: 1;
    aspect-ratio: 1;
    border-radius: 4px;
    background: var(--border);
}

.heatmap-cell[data-value="1"] { background: rgba(16, 185, 129, 0.3); }
.heatmap-cell[data-value="2"] { background: rgba(16, 185, 129, 0.6); }
.heatmap-cell[data-value="3"] { background: #10b981; }

.heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.legend-scale {
    display: flex;
    gap: 0.25rem;
}

.legend-cell {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}

.legend-cell.low { background: rgba(16, 185, 129, 0.3); }
.legend-cell.medium { background: rgba(16, 185, 129, 0.6); }
.legend-cell.high { background: #10b981; }

.heatmap-tip {
    text-align: center;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}

/* Costs Summary */
.costs-summary {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.cost-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.cost-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: var(--background);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
}

.cost-label {
    flex: 1;
}

.cost-value {
    font-weight: 600;
}

.cost-item.total {
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
    margin-top: 0.5rem;
}

.cost-item.total .cost-label {
    font-weight: 600;
}

.cost-item.total .cost-value {
    color: var(--danger);
}

/* Goal Progress */
.goal-progress {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.goal-circle {
    width: 120px;
    height: 120px;
    position: relative;
}

.goal-circle svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.goal-circle circle {
    transition: stroke-dashoffset 0.5s ease;
}

.goal-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.goal-percent {
    font-size: 1.5rem;
    font-weight: 700;
    display: block;
}

.goal-label {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.goal-details {
    flex: 1;
}

.goal-stat {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

.goal-stat:last-child {
    border-bottom: none;
}

.goal-stat-label {
    color: var(--text-muted);
}

.goal-stat-value {
    font-weight: 600;
}

.goal-projection {
    margin-top: 1rem;
    padding: 0.75rem;
    background: var(--background);
    border-radius: 8px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.goal-projection i {
    color: var(--primary);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

.empty-state.small {
    padding: 1rem;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--surface);
    border-radius: 12px;
    width: 90%;
    max-width: 450px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
}

.modal-body {
    padding: 1.25rem;
}

.modal-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--background);
    color: var(--text);
    font-size: 0.9rem;
}

.form-group textarea {
    min-height: 60px;
    resize: vertical;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.quick-calc {
    display: flex;
    justify-content: space-around;
    padding: 1rem;
    background: var(--background);
    border-radius: 8px;
}

.quick-calc strong {
    color: var(--success);
}

.goal-suggestions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.goal-suggestions span {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.goal-suggestions button {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    cursor: pointer;
    font-size: 0.85rem;
}

.goal-suggestions button:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.btn-primary {
    padding: 0.75rem 1.25rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-secondary {
    padding: 0.75rem 1.25rem;
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
}

@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: 1fr 1fr;
    }

    .tracker-grid {
        grid-template-columns: 1fr;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .goal-progress {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    initChart();

    // Set today's date as default
    document.getElementById('gigDate').valueAsDate = new Date();
    document.getElementById('expenseDate').valueAsDate = new Date();

    // Quick calc listeners
    ['gigEarnings', 'gigMinutes', 'gigDeliveries', 'gigTips'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', updateQuickCalc);
    });
});

function loadData() {
    const gigs = JSON.parse(localStorage.getItem('gig_logs') || '[]');
    const expenses = JSON.parse(localStorage.getItem('gig_expenses') || '[]');
    const goal = JSON.parse(localStorage.getItem('gig_goal') || '{"amount": 10000}');

    updateStats(gigs, expenses);
    updateRecentGigs(gigs);
    updateCosts(expenses);
    updateGoal(gigs, goal);
    updatePlatformStats(gigs);
}

function updateStats(gigs, expenses) {
    const now = new Date();
    const thisMonth = gigs.filter(g => {
        const d = new Date(g.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });

    const totalEarnings = thisMonth.reduce((sum, g) => sum + g.earnings + (g.tips || 0), 0);
    const totalMinutes = thisMonth.reduce((sum, g) => sum + g.minutes, 0);
    const totalHours = totalMinutes / 60;

    const monthExpenses = expenses.filter(e => {
        const d = new Date(e.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    }).reduce((sum, e) => sum + e.amount, 0);

    const effectiveRate = totalHours > 0 ? Math.round((totalEarnings - monthExpenses) / totalHours) : 0;

    document.getElementById('monthlyEarnings').textContent = formatCurrency(totalEarnings);
    document.getElementById('monthlyHours').textContent = totalHours.toFixed(1) + ' h';
    document.getElementById('effectiveRate').textContent = effectiveRate + ' kr/h';
    document.getElementById('monthlyGigs').textContent = thisMonth.length;
}

function updateRecentGigs(gigs) {
    const recent = gigs.slice(-5).reverse();
    const container = document.getElementById('recentGigs');

    if (recent.length === 0) {
        container.innerHTML = `
            <div class="empty-state small">
                <p>Inga gigs loggade an</p>
                <button class="btn-small" onclick="openLogGigModal()">Logga ditt forsta</button>
            </div>
        `;
        return;
    }

    container.innerHTML = recent.map(gig => {
        const hourlyRate = Math.round((gig.earnings + (gig.tips || 0)) / (gig.minutes / 60));
        return `
            <div class="gig-item">
                <div class="gig-icon" style="background: ${getPlatformColor(gig.platform)}">
                    <i class="fas fa-${getPlatformIcon(gig.platform)}"></i>
                </div>
                <div class="gig-info">
                    <span class="gig-platform">${getPlatformName(gig.platform)}</span>
                    <span class="gig-meta">${formatDate(gig.date)} &bull; ${gig.minutes} min</span>
                </div>
                <div class="gig-earnings">
                    <span class="gig-amount">${formatCurrency(gig.earnings + (gig.tips || 0))}</span>
                    <span class="gig-rate">${hourlyRate} kr/h</span>
                </div>
            </div>
        `;
    }).join('');
}

function updateCosts(expenses) {
    const now = new Date();
    const thisMonth = expenses.filter(e => {
        const d = new Date(e.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });

    const byCategory = {};
    thisMonth.forEach(e => {
        byCategory[e.category] = (byCategory[e.category] || 0) + e.amount;
    });

    document.getElementById('fuelCost').textContent = formatCurrency(byCategory.fuel || 0);
    document.getElementById('vehicleCost').textContent = formatCurrency(byCategory.vehicle || 0);
    document.getElementById('phoneCost').textContent = formatCurrency(byCategory.phone || 0);
    document.getElementById('otherCost').textContent = formatCurrency(
        (byCategory.equipment || 0) + (byCategory.insurance || 0) + (byCategory.other || 0)
    );
    document.getElementById('totalCosts').textContent = formatCurrency(
        thisMonth.reduce((sum, e) => sum + e.amount, 0)
    );
}

function updateGoal(gigs, goal) {
    const now = new Date();
    const thisMonth = gigs.filter(g => {
        const d = new Date(g.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });

    const current = thisMonth.reduce((sum, g) => sum + g.earnings + (g.tips || 0), 0);
    const target = goal.amount;
    const percent = Math.min(100, Math.round((current / target) * 100));

    document.getElementById('goalTarget').textContent = formatCurrency(target);
    document.getElementById('goalCurrent').textContent = formatCurrency(current);
    document.getElementById('goalRemaining').textContent = formatCurrency(Math.max(0, target - current));
    document.getElementById('goalPercent').textContent = percent + '%';

    // Update circle
    const offset = 283 - (283 * percent / 100);
    document.getElementById('goalProgress').style.strokeDashoffset = offset;

    // Projection
    const daysThisMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const daysPassed = now.getDate();
    const dailyRate = current / daysPassed;
    const daysToGoal = dailyRate > 0 ? Math.ceil((target - current) / dailyRate) : daysThisMonth;

    if (current >= target) {
        document.getElementById('goalProjection').innerHTML = `
            <i class="fas fa-check-circle" style="color: var(--success)"></i>
            <span>Grattis! Du har natt ditt manadsmol!</span>
        `;
    } else {
        document.getElementById('goalProjection').innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>Med nuvarande takt nar du malet om <strong>${daysToGoal} dagar</strong></span>
        `;
    }
}

function updatePlatformStats(gigs) {
    const now = new Date();
    const thisMonth = gigs.filter(g => {
        const d = new Date(g.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });

    const byPlatform = {};
    thisMonth.forEach(g => {
        if (!byPlatform[g.platform]) {
            byPlatform[g.platform] = { earnings: 0, minutes: 0 };
        }
        byPlatform[g.platform].earnings += g.earnings + (g.tips || 0);
        byPlatform[g.platform].minutes += g.minutes;
    });

    document.querySelectorAll('.platform-item').forEach(item => {
        const platform = item.dataset.platform;
        const stats = byPlatform[platform] || { earnings: 0, minutes: 0 };
        const hourlyRate = stats.minutes > 0 ? Math.round(stats.earnings / (stats.minutes / 60)) : 0;

        item.querySelector('.platform-earnings').textContent = formatCurrency(stats.earnings) + ' denna manad';
        item.querySelector('.platform-rate').textContent = hourlyRate + ' kr/h';
    });
}

function initChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    window.earningsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: getLast7Days(),
            datasets: [{
                label: 'Inkomst',
                data: [0, 0, 0, 0, 0, 0, 0],
                backgroundColor: '#6366f1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => formatCurrency(value)
                    }
                }
            }
        }
    });

    updateChart();
}

function updateChart() {
    const gigs = JSON.parse(localStorage.getItem('gig_logs') || '[]');
    const last7Days = getLast7Days();
    const data = last7Days.map(day => {
        const dayGigs = gigs.filter(g => formatDate(g.date) === day);
        return dayGigs.reduce((sum, g) => sum + g.earnings + (g.tips || 0), 0);
    });

    window.earningsChart.data.datasets[0].data = data;
    window.earningsChart.update();
}

function updateQuickCalc() {
    const earnings = parseFloat(document.getElementById('gigEarnings').value) || 0;
    const tips = parseFloat(document.getElementById('gigTips').value) || 0;
    const minutes = parseFloat(document.getElementById('gigMinutes').value) || 0;
    const deliveries = parseFloat(document.getElementById('gigDeliveries').value) || 0;

    const total = earnings + tips;
    const hourly = minutes > 0 ? Math.round(total / (minutes / 60)) : 0;
    const perDelivery = deliveries > 0 ? Math.round(total / deliveries) : '-';

    document.getElementById('calcHourly').textContent = hourly + ' kr/h';
    document.getElementById('calcPerDelivery').textContent = typeof perDelivery === 'number' ? perDelivery + ' kr' : perDelivery;
}

// Modal functions
function openLogGigModal() {
    document.getElementById('gigForm').reset();
    document.getElementById('gigDate').valueAsDate = new Date();
    updateQuickCalc();
    document.getElementById('logGigModal').classList.add('active');
}

function openExpenseModal() {
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseDate').valueAsDate = new Date();
    document.getElementById('expenseModal').classList.add('active');
}

function openGoalModal() {
    const goal = JSON.parse(localStorage.getItem('gig_goal') || '{"amount": 10000}');
    document.getElementById('goalAmount').value = goal.amount;
    document.getElementById('goalModal').classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function saveGig() {
    const gig = {
        id: Date.now(),
        platform: document.getElementById('gigPlatform').value,
        date: document.getElementById('gigDate').value,
        timeOfDay: document.getElementById('gigTimeOfDay').value,
        earnings: parseFloat(document.getElementById('gigEarnings').value),
        minutes: parseInt(document.getElementById('gigMinutes').value),
        deliveries: parseInt(document.getElementById('gigDeliveries').value) || 0,
        tips: parseFloat(document.getElementById('gigTips').value) || 0,
        notes: document.getElementById('gigNotes').value
    };

    const gigs = JSON.parse(localStorage.getItem('gig_logs') || '[]');
    gigs.push(gig);
    localStorage.setItem('gig_logs', JSON.stringify(gigs));

    closeModal('logGigModal');
    loadData();
    updateChart();

    if (window.WealthAgent) {
        WealthAgent.showToast('Gig loggat!', 'success');
    }
}

function saveExpense() {
    const expense = {
        id: Date.now(),
        category: document.getElementById('expenseCategory').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        description: document.getElementById('expenseDescription').value
    };

    const expenses = JSON.parse(localStorage.getItem('gig_expenses') || '[]');
    expenses.push(expense);
    localStorage.setItem('gig_expenses', JSON.stringify(expenses));

    closeModal('expenseModal');
    loadData();

    if (window.WealthAgent) {
        WealthAgent.showToast('Kostnad sparad!', 'success');
    }
}

function setGoal(amount) {
    document.getElementById('goalAmount').value = amount;
}

function saveGoal() {
    const goal = {
        amount: parseInt(document.getElementById('goalAmount').value) || 10000
    };

    localStorage.setItem('gig_goal', JSON.stringify(goal));
    closeModal('goalModal');
    loadData();

    if (window.WealthAgent) {
        WealthAgent.showToast('Mal uppdaterat!', 'success');
    }
}

// Helper functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 }).format(amount);
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
}

function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        days.push(d.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }));
    }
    return days;
}

function getPlatformColor(platform) {
    const colors = {
        uber: '#000',
        bolt: '#34D186',
        foodora: '#D70F64',
        wolt: '#009DE0',
        taskrabbit: '#00c3a5',
        other: '#6366f1'
    };
    return colors[platform] || '#6366f1';
}

function getPlatformIcon(platform) {
    const icons = {
        uber: 'car',
        bolt: 'bolt',
        foodora: 'motorcycle',
        wolt: 'utensils',
        taskrabbit: 'tools',
        other: 'briefcase'
    };
    return icons[platform] || 'briefcase';
}

function getPlatformName(platform) {
    const names = {
        uber: 'Uber',
        bolt: 'Bolt',
        foodora: 'Foodora',
        wolt: 'Wolt',
        taskrabbit: 'TaskRabbit',
        other: 'Annat'
    };
    return names[platform] || platform;
}
</script>
{% endblock %}
